# ğŸ”„ Diagrama de Flujo Completo - Sistema de Colas RabbitMQ
## Switch Transaccional DIGICONECU - Flujo AsÃ­ncrono

---

## ğŸ“Š DIAGRAMA PRINCIPAL DEL FLUJO

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        FLUJO ASÃNCRONO DE TRANSFERENCIA INTERBANCARIA - 5 FASES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FASE 1: SOLICITUD DE TRANSFERENCIA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        CLIENTE DEL BANCO            â”‚
    â”‚     (App MÃ³vil / Web Banking)       â”‚
    â”‚                                     â”‚
    â”‚  "Quiero transferir $100 a          â”‚
    â”‚   cuenta 123456 del Banco BANTEC"   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ 
                      â”‚ HTTP POST (interno)
                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       BANCO ORIGEN (NEXUS)          â”‚
    â”‚                                     â”‚
    â”‚  â€¢ Valida cliente autenticado       â”‚
    â”‚  â€¢ Verifica fondos disponibles      â”‚
    â”‚  â€¢ Construye mensaje pacs.008       â”‚
    â”‚  â€¢ Genera instructionId Ãºnico       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ â‘  HTTP POST pacs.008
                      â”‚    ğŸŒ Kong Gateway (34.16.106.7:8000)
                      â”‚    POST /api/v1/transacciones
                      â”‚
                      â”‚    {
                      â”‚      "header": { 
                      â”‚        "messageId": "MSG-123",
                      â”‚        "originatingBankId": "NEXUS"
                      â”‚      },
                      â”‚      "body": {
                      â”‚        "instructionId": "uuid-abc-123",
                      â”‚        "amount": { "currency": "USD", "value": 100.00 },
                      â”‚        "creditor": {
                      â”‚          "accountId": "123456",
                      â”‚          "targetBankId": "BANTEC" â—„â”€â”€ ROUTING KEY
                      â”‚        }
                      â”‚      }
                      â”‚    }
                      â–¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FASE 2: PROCESAMIENTO EN EL SWITCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                 SWITCH DIGICONECU                                       â”‚
    â”‚                                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  TransaccionControlador.java                                                     â”‚  â”‚
    â”‚  â”‚  @PostMapping("/api/v1/transacciones")                                           â”‚  â”‚
    â”‚  â”‚  â†’ Recibe pacs.008                                                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                      â”‚                                                                  â”‚
    â”‚                      â–¼                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  TransaccionServicio.java                                                        â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  1ï¸âƒ£ Validar idempotencia (Redis)       â†’ Evita duplicados                        â”‚  â”‚
    â”‚  â”‚  2ï¸âƒ£ Validar bancos en Directorio       â†’ NEXUS y BANTEC existen como bancos vÃ¡lidos  â”‚  â”‚
    â”‚  â”‚  3ï¸âƒ£ Registrar DEBIT en Ledger          â†’ Quita $100 al "Balance" de NEXUS        â”‚  â”‚
    â”‚  â”‚  4ï¸âƒ£ Registrar posiciÃ³n en Clearing     â†’ DEBITO para compensaciÃ³n                â”‚  â”‚
    â”‚  â”‚  5ï¸âƒ£ Publicar mensaje a RabbitMQ        â—„â”€â”€ MOMENTO CLAVE                         â”‚  â”‚
    â”‚  â”‚  6ï¸âƒ£ Guardar tx con estado "QUEUED"                                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                      â”‚                                                                  â”‚
    â”‚                      â”‚ mensajeriaServicio.publicarTransferencia("BANTEC", mensaje)      â”‚
    â”‚                      â–¼                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  MensajeriaServicio.java                                                         â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  rabbitTemplate.convertAndSend(                                                  â”‚  â”‚
    â”‚  â”‚      "ex.transfers.tx",    â† Exchange                                            â”‚  â”‚
    â”‚  â”‚      "BANTEC",             â† Routing Key                                         â”‚  â”‚
    â”‚  â”‚      mensaje               â† pacs.008 como JSON                                  â”‚  â”‚
    â”‚  â”‚  );                                                                              â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ â‘¡ HTTP 202 Accepted (INMEDIATO, ~100ms)
                      â”‚    {
                      â”‚      "idInstruccion": "uuid-abc-123",
                      â”‚      "estado": "QUEUED",
                      â”‚      "mensaje": "Transferencia encolada"
                      â”‚    }
                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       BANCO ORIGEN (NEXUS)          â”‚
    â”‚                                     â”‚
    â”‚  âœ… Recibe 202 Accepted             â”‚
    â”‚  âœ… Guarda instructionId            â”‚
    â”‚  âœ… LIBRE para otras operaciones    â”‚
    â”‚  â³ EsperarÃ¡ webhook con resultado  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FASE 3: ENRUTAMIENTO EN RABBITMQ (AMAZON MQ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                          RABBITMQ - AMAZON MQ                                           â”‚
    â”‚                  amqps://...mq.us-east-2.on.aws:5671                                    â”‚
    â”‚                                                                                         â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚   â”‚                       ex.transfers.tx (DIRECT EXCHANGE)                         â”‚   â”‚
    â”‚   â”‚                                                                                 â”‚   â”‚
    â”‚   â”‚   Regla: routingKey debe coincidir EXACTAMENTE con el bindingKey de la cola    â”‚   â”‚
    â”‚   â”‚                                                                                 â”‚   â”‚
    â”‚   â”‚   Mensaje entrante: routingKey = "BANTEC"                                       â”‚   â”‚
    â”‚   â”‚                          â”‚                                                      â”‚   â”‚
    â”‚   â”‚                          â”‚ Â¿Coincide con algÃºn binding?                         â”‚   â”‚
    â”‚   â”‚                          â”‚                                                      â”‚   â”‚
    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
    â”‚   â”‚   â”‚                      â–¼                                                  â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   BINDING TABLE:                                                        â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•           â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   bindingKey = "NEXUS"   â†’ q.bank.NEXUS.in   âŒ No coincide             â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   bindingKey = "BANTEC"  â†’ q.bank.BANTEC.in  âœ… Â¡COINCIDE!              â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   bindingKey = "ARCBANK" â†’ q.bank.ARCBANK.in âŒ No coincide             â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   bindingKey = "ECUSOL"  â†’ q.bank.ECUSOL.in  âŒ No coincide             â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
    â”‚   â”‚                                                                                 â”‚   â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â”‚                                                              â”‚
    â”‚                          â”‚ Mensaje enrutado                                             â”‚
    â”‚                          â–¼                                                              â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚   â”‚                                                                                 â”‚   â”‚
    â”‚   â”‚   q.bank.NEXUS.in        q.bank.BANTEC.in        q.bank.ARCBANK.in             â”‚   â”‚
    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
    â”‚   â”‚   â”‚             â”‚        â”‚  ğŸ“¨ MSG     â”‚         â”‚             â”‚               â”‚   â”‚
    â”‚   â”‚   â”‚   (vacÃ­a)   â”‚        â”‚  pacs.008   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”‚   (vacÃ­a)   â”‚               â”‚   â”‚
    â”‚   â”‚   â”‚             â”‚        â”‚  $100       â”‚         â”‚             â”‚               â”‚   â”‚
    â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
    â”‚   â”‚                                 â”‚                                               â”‚   â”‚
    â”‚   â”‚   Si falla procesamiento:       â”‚                                               â”‚   â”‚
    â”‚   â”‚   q.bank.BANTEC.dlq â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (Dead Letter Queue)                          â”‚   â”‚
    â”‚   â”‚                                                                                 â”‚   â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ â‘¢ @RabbitListener consume el mensaje
                          â”‚
                          â–¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FASE 4: PROCESAMIENTO EN BANCO DESTINO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              BANCO DESTINO (BANTEC)                                     â”‚
    â”‚                                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  TransferenciaListener.java                                                      â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  @RabbitListener(queues = "q.bank.BANTEC.in")                                    â”‚  â”‚
    â”‚  â”‚  public void procesarTransferencia(MensajeISO mensaje) {                         â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚      1ï¸âƒ£ Extraer datos del mensaje pacs.008                                       â”‚  â”‚
    â”‚  â”‚         - instructionId, monto, cuenta destino                                   â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚      2ï¸âƒ£ Validar cuenta destino                                                   â”‚  â”‚
    â”‚  â”‚         - Â¿Existe cuenta 123456? â†’ SI                                            â”‚  â”‚
    â”‚  â”‚         - Â¿EstÃ¡ bloqueada? â†’ NO                                                  â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚      3ï¸âƒ£ Procesar depÃ³sito en Core Bancario                                       â”‚  â”‚
    â”‚  â”‚         - Acreditar $100 a cuenta 123456                                         â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚      4ï¸âƒ£ Construir StatusReportDTO (pacs.002)                                     â”‚  â”‚
    â”‚  â”‚         - status: "COMPLETED"                                                    â”‚  â”‚
    â”‚  â”‚         - originalInstructionId: "uuid-abc-123"                                  â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚      5ï¸âƒ£ Enviar callback al Switch                                                â”‚  â”‚
    â”‚  â”‚  }                                                                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                      â”‚                                                                  â”‚
    â”‚                      â”‚ switchCallbackService.notificarSwitch(resultado);                â”‚
    â”‚                      â–¼                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  SwitchCallbackService.java                                                      â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  HTTP POST http://34.16.106.7:8000/api/v1/transacciones/callback                 â”‚  â”‚
    â”‚  â”‚  {                                                                               â”‚  â”‚
    â”‚  â”‚    "header": {                                                                   â”‚  â”‚
    â”‚  â”‚      "messageId": "RESP-456",                                                    â”‚  â”‚
    â”‚  â”‚      "respondingBankId": "BANTEC"                                                â”‚  â”‚
    â”‚  â”‚    },                                                                            â”‚  â”‚
    â”‚  â”‚    "body": {                                                                     â”‚  â”‚
    â”‚  â”‚      "originalInstructionId": "uuid-abc-123",                                    â”‚  â”‚
    â”‚  â”‚      "status": "COMPLETED",                                                      â”‚  â”‚
    â”‚  â”‚      "processedDateTime": "2026-02-01T10:30:00"                                  â”‚  â”‚
    â”‚  â”‚    }                                                                             â”‚  â”‚
    â”‚  â”‚  }                                                                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ â‘£ HTTP POST /api/v1/transacciones/callback
                      â”‚
                      â–¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FASE 5: CALLBACK Y NOTIFICACIÃ“N FINAL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                 SWITCH DIGICONECU                                       â”‚
    â”‚                                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  CallbackControlador.java                                                        â”‚  â”‚
    â”‚  â”‚  @PostMapping("/api/v1/transacciones/callback")                                  â”‚  â”‚
    â”‚  â”‚  â†’ Recibe StatusReportDTO (pacs.002)                                             â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                      â”‚                                                                  â”‚
    â”‚                      â–¼                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  CallbackServicio.java                                                           â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  1ï¸âƒ£ Buscar transacciÃ³n por originalInstructionId                                 â”‚  â”‚
    â”‚  â”‚     â†’ Encuentra tx en estado "QUEUED"                                            â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  2ï¸âƒ£ Si status == "COMPLETED":                                                    â”‚  â”‚
    â”‚  â”‚     â€¢ Registrar CREDIT en Ledger â†’ Da $100 al "Balance" de BANTEC               â”‚  â”‚
    â”‚  â”‚     â€¢ Registrar posiciÃ³n CRÃ‰DITO en Clearing                                     â”‚  â”‚
    â”‚  â”‚     â€¢ Actualizar tx.estado = "COMPLETED"                                         â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  3ï¸âƒ£ Si status == "REJECTED":                                                     â”‚  â”‚
    â”‚  â”‚     â€¢ Registrar CREDIT en Ledger â†’ Devuelve $100 al "Balance" de NEXUS          â”‚  â”‚
    â”‚  â”‚     â€¢ Reversar posiciÃ³n en Clearing                                              â”‚  â”‚
    â”‚  â”‚     â€¢ Actualizar tx.estado = "REJECTED"                                          â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  4ï¸âƒ£ Notificar al banco origen vÃ­a webhook                                        â”‚  â”‚
    â”‚  â”‚     â†’ Buscar webhook URL de NEXUS en Directorio                                  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                      â”‚                                                                  â”‚
    â”‚                      â”‚ notificarBancoOrigen(tx, statusReport)                           â”‚
    â”‚                      â–¼                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  HTTP POST al webhook del banco origen (configurado en Directorio)               â”‚  â”‚
    â”‚  â”‚                                                                                  â”‚  â”‚
    â”‚  â”‚  URL: https://api.nexusbank.com/webhooks/transfers                               â”‚  â”‚
    â”‚  â”‚  {                                                                               â”‚  â”‚
    â”‚  â”‚    "header": { "respondingBankId": "BANTEC" },                                   â”‚  â”‚
    â”‚  â”‚    "body": {                                                                     â”‚  â”‚
    â”‚  â”‚      "originalInstructionId": "uuid-abc-123",                                    â”‚  â”‚
    â”‚  â”‚      "status": "COMPLETED"                                                       â”‚  â”‚
    â”‚  â”‚    }                                                                             â”‚  â”‚
    â”‚  â”‚  }                                                                               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ â‘¤ HTTP POST webhook de notificaciÃ³n
                      â”‚
                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       BANCO ORIGEN (NEXUS)          â”‚
    â”‚                                     â”‚
    â”‚  âœ… Recibe confirmaciÃ³n final       â”‚
    â”‚  âœ… Actualiza estado interno        â”‚
    â”‚  âœ… Notifica al cliente             â”‚
    â”‚                                     â”‚
    â”‚  "Tu transferencia de $100 a        â”‚
    â”‚   BANTEC fue completada"            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                            âœ… FIN DEL FLUJO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“‹ ESTADOS DE LA TRANSACCIÃ“N

| Estado | DescripciÃ³n | QuiÃ©n lo establece |
|--------|-------------|--------------------|
| `RECEIVED` | TransacciÃ³n recibida, en validaciÃ³n | Switch (inicio) |
| `QUEUED` | Publicada a RabbitMQ, esperando procesamiento | Switch (despuÃ©s de publicar) |
| `COMPLETED` | Procesada exitosamente por banco destino | Switch (despuÃ©s de callback) |
| `REJECTED` | Rechazada por banco destino | Switch (despuÃ©s de callback) |
| `FAILED` | Error en validaciÃ³n o procesamiento | Switch (en caso de error) |

---

## ğŸ—ï¸ COMPONENTES DEL SWITCH UTILIZADOS

| Componente | Responsabilidad |
|------------|-----------------|
| `TransaccionControlador.java` | Recibe pacs.008, retorna HTTP 202 |
| `TransaccionServicio.java` | Valida, registra DEBIT, publica a RabbitMQ |
| `MensajeriaServicio.java` | Publica mensajes al exchange `ex.transfers.tx` |
| `CallbackControlador.java` | Recibe callbacks de bancos destino |
| `CallbackServicio.java` | Procesa callback, registra CREDIT, notifica origen |
| `RabbitMQConfig.java` | Define exchanges, colas y bindings |

---

## ğŸ—ƒï¸ COLAS CONFIGURADAS EN RABBITMQ

| Cola Principal | Dead Letter Queue | Routing Key |
|----------------|-------------------|-------------|
| `q.bank.NEXUS.in` | `q.bank.NEXUS.dlq` | `NEXUS` |
| `q.bank.BANTEC.in` | `q.bank.BANTEC.dlq` | `BANTEC` |
| `q.bank.ARCBANK.in` | `q.bank.ARCBANK.dlq` | `ARCBANK` |
| `q.bank.ECUSOL.in` | `q.bank.ECUSOL.dlq` | `ECUSOL` |

---

## âœ… CHECKLIST DE IMPLEMENTACIÃ“N

### Switch (Ya Implementado) âœ…

| # | Componente | Estado | DescripciÃ³n |
|---|------------|--------|-------------|
| 1 | `TransaccionServicio.java` | âœ… | Usa `MensajeriaServicio` para publicar |
| 2 | `TransaccionControlador.java` | âœ… | Retorna HTTP 202 para estado QUEUED |
| 3 | `MensajeriaServicio.java` | âœ… | Publica a `ex.transfers.tx` con routing key |
| 4 | `RabbitMQConfig.java` | âœ… | Exchanges, colas y bindings configurados |
| 5 | `CallbackControlador.java` | âœ… | Endpoint POST /callback |
| 6 | `CallbackServicio.java` | âœ… | Procesa callback, actualiza ledger, notifica |
| 7 | `StatusReportDTO.java` | âœ… | DTO para pacs.002 |

### Bancos (Por Implementar) â³

| # | Componente | Estado | DescripciÃ³n |
|---|------------|--------|-------------|
| 1 | ConexiÃ³n RabbitMQ | â³ | Configurar `application.yml` con credenciales |
| 2 | `TransferenciaListener.java` | â³ | `@RabbitListener` para consumir de cola |
| 3 | `SwitchCallbackService.java` | â³ | HTTP POST al endpoint de callback |
| 4 | DTOs (`MensajeISO`, `StatusReportDTO`) | â³ | Estructuras de datos |

---

## ğŸ§ª ENDPOINTS PARA PRUEBAS

### 1. Enviar Transferencia (Banco Origen â†’ Switch)

```bash
POST http://34.16.106.7:8000/api/v1/transacciones
Content-Type: application/json
apikey: SU_API_KEY

{
  "header": {
    "messageId": "MSG-TEST-001",
    "creationDateTime": "2026-02-01T10:00:00",
    "originatingBankId": "NEXUS"
  },
  "body": {
    "instructionId": "550e8400-e29b-41d4-a716-446655440000",
    "amount": {
      "currency": "USD",
      "value": 100.00
    },
    "debtor": {
      "name": "Juan PÃ©rez",
      "accountId": "1234567890"
    },
    "creditor": {
      "name": "MarÃ­a GarcÃ­a",
      "accountId": "0987654321",
      "targetBankId": "BANTEC"
    }
  }
}
```

**Respuesta esperada (HTTP 202):**
```json
{
  "idInstruccion": "550e8400-e29b-41d4-a716-446655440000",
  "estado": "QUEUED"
}
```

### 2. Enviar Callback (Banco Destino â†’ Switch)

```bash
POST http://34.16.106.7:8000/api/v1/transacciones/callback
Content-Type: application/json

{
  "header": {
    "messageId": "RESP-001",
    "creationDateTime": "2026-02-01T10:05:00",
    "respondingBankId": "BANTEC"
  },
  "body": {
    "originalInstructionId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "COMPLETED",
    "processedDateTime": "2026-02-01T10:05:00"
  }
}
```

**Respuesta esperada (HTTP 200):**
```json
{
  "idInstruccion": "550e8400-e29b-41d4-a716-446655440000",
  "estado": "COMPLETED"
}
```

### 3. Consultar Estado de TransacciÃ³n

```bash
GET http://34.16.106.7:8000/api/v1/transacciones/550e8400-e29b-41d4-a716-446655440000
```

---

## ğŸ“ RESUMEN EJECUTIVO

**Â¿QuÃ© cambiamos?**
- De flujo **SÃNCRONO** (Switch esperaba respuesta HTTP del banco destino)
- A flujo **ASÃNCRONO** (Switch publica a RabbitMQ y responde inmediatamente)

**Â¿Por quÃ©?**
- Mayor resiliencia (si banco destino estÃ¡ caÃ­do, mensaje queda en cola)
- Mejor rendimiento (banco origen no queda bloqueado)
- Desacoplamiento (bancos procesan a su propio ritmo)

**Â¿QuÃ© debe hacer cada banco?**
1. Conectarse a RabbitMQ y consumir de su cola
2. Procesar la transferencia
3. Enviar HTTP POST callback al Switch con el resultado
