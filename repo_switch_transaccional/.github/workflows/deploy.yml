name: Deploy to Google Cloud VM

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Orchestrator
      uses: actions/checkout@v3

    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.GCP_VM_HOST }}
        username: ${{ secrets.GCP_VM_USERNAME }}
        key: ${{ secrets.GCP_VM_SSH_KEY }}
        script: |
          echo "ðŸš€ Iniciando despliegue automatizado en GCP..."
          
          # 1. Navegar a la carpeta raÃ­z de proyectos
          cd /opt/switch
          
          # 2. Actualizar Orquestador (donde estÃ¡ el docker-compose)
          echo "ðŸ“¥ Actualizando switch-transaccional..."
          git -C switch-transaccional pull origin main
          
          # 3. Actualizar Microservicios (Git Pull en bucle o explÃ­cito)
          # Asumimos que ya estÃ¡n clonados. Si no, habrÃ­a que clonarlos la primera vez manualmente.
          
          echo "ðŸ“¥ Actualizando ms-nucleo..."
          git -C ms-nucleo pull origin main
          
          echo "ðŸ“¥ Actualizando ms-directorio..."
          git -C ms-directorio pull origin main
          
          echo "ðŸ“¥ Actualizando ms-contabilidad..."
          git -C ms-contabilidad pull origin main
          
          echo "ðŸ“¥ Actualizando ms-compensacion..."
          git -C ms-compensacion pull origin main
          
          echo "ðŸ“¥ Actualizando ms-devolucion..."
          git -C ms-devolucion pull origin main
          
          echo "ðŸ“¥ Actualizando switch-frontend..."
          git -C switch-frontend pull origin main
          
          # 4. Reconstruir y Levantar Contenedores
          echo "ðŸ³ Reconstruyendo contenedores con Docker Compose..."
          # Usamos el archivo del orquestador, pero los contextos estÃ¡n en ../ (funciona porque cd estÃ¡ en /opt/switch)
          
          # IMPORTANTE: docker-compose busca paths relativos al archivo yml.
          # Si ejecutamos: docker-compose -f switch-transaccional/docker-compose-full.yml
          # El contexto "../ms-nucleo" se resuelve relativo a "switch-transaccional/", o sea: "switch-transaccional/../ms-nucleo" -> "ms-nucleo".
          # ESTO ES CORRECTO.
          
          docker-compose -f switch-transaccional/docker-compose-full.yml up -d --build --remove-orphans
          
          echo "âœ… Despliegue completado exitosamente."
