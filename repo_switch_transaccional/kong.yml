_format_version: "3.0"

services:
  # ==============================================================================
  # 1. FRONTEND / DASHBOARD API (Acceso Web)
  # ==============================================================================
  
  # Nucleo (Dashboard, Stats)
  - name: frontend-nucleo
    url: http://ms-nucleo:8082/api/v1/transacciones
    routes:
      - name: DASHBOARD-Nucleo
        paths: ["/transacciones"]
        strip_path: true
    plugins:
      - name: cors
        config: { origins: ["*"], methods: ["GET", "POST", "OPTIONS"] }

  # Directorio (Gestión Bancos)
  - name: frontend-directorio
    url: http://ms-directorio:8081/api/v1
    routes:
      - name: DASHBOARD-Directorio
        paths: ["/directorio"]
        strip_path: true
    plugins:
      - name: cors
        config: { origins: ["*"], methods: ["GET", "POST", "PATCH", "OPTIONS"] }

  # Contabilidad (Ledger)
  - name: frontend-contabilidad
    url: http://ms-contabilidad:8083/api/v1
    routes:
      - name: DASHBOARD-Contabilidad
        paths: ["/contabilidad"]
        strip_path: true
    plugins:
      - name: cors
        config: { origins: ["*"], methods: ["GET", "POST", "OPTIONS"] }

  # Compensación
  - name: frontend-compensacion
    url: http://ms-compensacion:8084/api/v1
    routes:
      - name: DASHBOARD-Compensacion
        paths: ["/compensacion"]
        strip_path: true
    plugins:
      - name: cors
        config: { origins: ["*"], methods: ["GET", "POST", "OPTIONS"] }

  # ==============================================================================
  # 2. CONTRACT V2 (Interfaz Unificada para Bancos)
  # ==============================================================================

  # RF-01 & RF-04: Transferencias y Consultas
  # Ruta Externa: /api/v2/switch/transfers
  # Ruta Interna: /api/v1/transacciones
  - name: v2-transfers-service
    url: http://ms-nucleo:8082/api/v1/transacciones
    routes:
      - name: RF01-Transferencia-Credito
        paths: ["/api/v2/switch/transfers"]
        strip_path: true
        methods: ["GET", "POST", "OPTIONS"]
      
      # RF-04: Consulta de Estado (Ruta Explícita)
      - name: RF04-Consulta-Estado
        paths: ["~/api/v2/switch/transfers/(?<id>\\S+)$"]
        strip_path: true
        methods: ["GET", "OPTIONS"]
    plugins:
      - name: key-auth
        config: { key_names: ["apikey"] }
      - name: cors
        config: { origins: ["*"] }

  # NEW: Account Lookup (Validación de Cuenta)
  - name: v2-accounts-service
    url: http://ms-nucleo:8082/api/v1/cuentas
    routes:
      - name: Account-Lookup-Service
        paths: ["/api/v2/switch/accounts"]
        strip_path: true
        methods: ["POST", "OPTIONS"]
    plugins:
      - name: key-auth
        config: { key_names: ["apikey"] }
      - name: cors
        config: { origins: ["*"] }

  # RF-07: Devoluciones (Returns)
  # Ruta Externa: /api/v2/switch/transfers/return
  # Ruta Interna: /api/v1/transacciones/devoluciones (NUCLEO - Para validación completa)
  - name: v2-returns-service
    url: http://ms-nucleo:8082/api/v1/transacciones/devoluciones
    routes:
      - name: RF07-Devolucion-Reverso
        paths: ["/api/v2/switch/transfers/return"]
        strip_path: true
        methods: ["POST", "OPTIONS"]
    plugins:
      - name: key-auth
        config: { key_names: ["apikey"] }
      - name: cors
        config: { origins: ["*"] }

  # RF-01.1: Funding / Saldo Técnico
  # Ruta Externa: /funding/{bankId}
  # Ruta Interna: /api/v1/ledger/cuentas/{bic}
  - name: v2-funding-service
    url: http://ms-contabilidad:8083/api/v1/ledger/cuentas
    routes:
      - name: RF01-1-Fondeo
        paths: ["/funding"]
        strip_path: true
        methods: ["GET", "OPTIONS"]
    plugins:
      - name: key-auth
        config: { key_names: ["apikey"] }
      - name: cors
        config: { origins: ["*"] }

consumers:
  - username: NEXUS_BANK
    keyauth_credentials:
      - key: NEXUS_SECRET_KEY_123
  - username: ECUSOL_BK
    keyauth_credentials:
      - key: PUBLIC_KEY_ECUSOL_67890
  - username: ARCBANK
    keyauth_credentials:
      - key: ARCBANK_SECRET_KEY_2025_XYZ
  - username: BANTEC
    keyauth_credentials:
      - key: BANTEC_SECRET_KEY_2025
  - username: SWITCH_ADMIN
    keyauth_credentials:
      - key: SWITCH_ADMIN_SUPER_SECRET_KEY
